//@version=6
indicator("EMA9 + Extended Pivot Lines", overlay=true)

// Calculate EMA 9
ema9 = ta.ema(close, 9)
plot(ema9, "EMA 9", color=color.blue, linewidth=2)

// —————— Daily Pivot Points (Extended) ——————
pivot_high = request.security(syminfo.tickerid, "D", high[1], lookahead=barmerge.lookahead_on)
pivot_low = request.security(syminfo.tickerid, "D", low[1], lookahead=barmerge.lookahead_on)
pivot_close = request.security(syminfo.tickerid, "D", close[1], lookahead=barmerge.lookahead_on)

// Calculate Pivot Levels
pivot = (pivot_high + pivot_low + pivot_close) / 3
daily_range = pivot_high - pivot_low

// Support Levels
s1 = (2 * pivot) - pivot_high
s2 = pivot - daily_range
s3 = pivot_low - 2 * (pivot_high - pivot)

// Resistance Levels
r1 = (2 * pivot) - pivot_low
r2 = pivot + daily_range
r3 = pivot_high + 2 * (pivot - pivot_low)

// —————— Plot Pivot Lines (Only Lines, No Labels) ——————
plot(pivot, "Pivot", color=color.yellow, linewidth=1)
plot(s1, "S1", color=color.red, linewidth=1)
plot(s2, "S2", color=color.red, linewidth=1)
plot(s3, "S3", color=color.red, linewidth=1)
plot(r1, "R1", color=color.green, linewidth=1)
plot(r2, "R2", color=color.green, linewidth=1)
plot(r3, "R3", color=color.green, linewidth=1)

// —————— Alert Conditions ——————
candle_above_ema = close > ema9
candle_below_ema = close < ema9

candle_between_levels = (low > s3 and high < s2) or (low > s2 and high < s1) or (low > s1 and high < pivot) or 
                         (low > pivot and high < r1) or (low > r1 and high < r2) or (low > r2 and high < r3)

time_stamp = timenow

if (candle_above_ema and candle_between_levels)
    alert("Candle is above EMA9 and not touching pivot points. Time: " + str.tostring(time_stamp) + " | Close Price: " + str.tostring(close), alert.freq_once_per_bar_close)

if (candle_below_ema and candle_between_levels)
    alert("Candle is below EMA9 and not touching pivot points. Time: " + str.tostring(time_stamp) + " | Close Price: " + str.tostring(close), alert.freq_once_per_bar_close)
